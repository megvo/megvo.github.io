<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Central Park Squirrels ‚Äî Game & Explorer</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    :root{
      --brown:#8B4513;
      --tan:#DEB887;
      --cream:#FFF8DC;
      --leaf:#2c5f2d;
      --sky1:#f5f7fa; --sky2:#c3cfe2;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(135deg,var(--sky1),var(--sky2));font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#222}
    .shell{max-width:1360px;margin:0 auto;padding:20px}
    .tabs{display:flex;gap:10px;justify-content:center;margin:10px 0 20px}
    .tab-btn{border:2px solid var(--leaf);background:#fff;color:var(--leaf);padding:10px 18px;border-radius:999px;cursor:pointer;font-weight:700}
    .tab-btn.active{background:var(--leaf);color:#fff;box-shadow:0 4px 12px rgba(44,95,45,.3)}
    .panel{display:none}
    .panel.active{display:block}
    .card{
      background:#fff;border-radius:24px;padding:28px;box-shadow:0 18px 50px rgba(0,0,0,.08);border:1px solid #e9ecef
    }
    /* Loading overlay for explorer */
    .loader {
      position: fixed; inset: 0; background: rgba(255,255,255,0.85);
      display: none; align-items: center; justify-content: center; z-index: 3000;
      font-weight: 800; color: var(--leaf); font-size: 20px;
    }
    .loader.show{display:flex}
    .spinner{width:48px;height:48px;border:5px solid #cfe7d0;border-top-color:var(--leaf);border-radius:50%;animation:spin 0.9s linear infinite;margin-right:14px}
    @keyframes spin {to{transform:rotate(360deg)}}

    /* ======== GAME (kept from your original, minimal tweaks) ======== */
    #game-container, #danger-map-container {
      background: linear-gradient(135deg, #FFF8DC 0%, #FAEBD7 100%);
      border-radius: 25px; padding: 30px; box-shadow: 0 8px 20px rgba(139, 69, 19, 0.2);
      max-width: 980px; margin:0 auto; border: 4px solid var(--tan);
    }
    #map-container, #danger-map-display {background: linear-gradient(135deg, #CD853F, #DEB887); border-radius: 15px; padding: 20px; position: relative; margin-bottom: 20px; box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);}
    #map, #danger-svg {
      background: linear-gradient(to bottom, #228B22 0%, #2E8B57 30%, #DAA520 70%, #CD853F 100%);
      border-radius: 12px; position: relative; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: block; margin: 0 auto;
      max-width: 100%;
    }
    h1 {text-align:center;color:var(--brown);margin:0 0 10px 0;font-size:28px;text-shadow:2px 2px 4px rgba(255,255,255,0.5);}
    .progress{text-align:center;color:var(--brown);font-size:15px;margin-bottom:15px;font-weight:bold}
    /* Bio modal */
    #bio-panel{background:linear-gradient(135deg,#FFF9F0,#FFFAF5);border-radius:15px;padding:20px;display:none;box-shadow:0 8px 24px rgba(139,69,19,.4);border:3px solid var(--tan);position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:100;max-width:380px;width:90%}
    .bio-title{font-size:20px;font-weight:bold;margin-bottom:10px;color:var(--brown);text-align:center}
    .bio-content{font-size:15px;line-height:1.8;color:#654321;margin-bottom:15px}
    .color-buttons{display:flex;gap:10px;justify-content:center}
    .color-btn{padding:12px 24px;border:none;border-radius:20px;cursor:pointer;font-size:14px;font-weight:bold;color:#fff;transition:all .2s;box-shadow:0 4px 8px rgba(0,0,0,.2);font-family:Georgia,serif}
    .btn-gray{background:linear-gradient(145deg,#999,#777)} .btn-cinnamon{background:linear-gradient(145deg,#D2691E,#A0522D)} .btn-black{background:linear-gradient(145deg,#3c3c3c,#1c1c1c)}
    .hint-btn{background:linear-gradient(145deg,#4CAF50,#388E3C);color:#fff;border:none;padding:12px 24px;font-size:14px;font-weight:bold;border-radius:20px;cursor:pointer;box-shadow:0 4px 8px rgba(0,0,0,.2);display:block;margin:0 auto 15px}
    .legend{display:none;justify-content:space-around;margin-top:0;font-size:12px;background:rgba(255,255,255,.6);padding:10px;border-radius:10px}
    .legend.visible{display:flex}
    .legend-item{display:flex;align-items:center;gap:5px;font-weight:bold;color:#654321}
    .legend-circle{width:14px;height:14px;border-radius:50%;box-shadow:0 2px 4px rgba(0,0,0,.2)}
    .feedback{text-align:center;font-size:18px;font-weight:bold;margin-top:10px;min-height:24px}
    .correct{color:#228B22} .incorrect{color:#DC143C}
    .acorn,.falling-squirrel{position:fixed;font-size:30px;pointer-events:none;z-index:1000}
    #congratulations{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#FFF8DC,#FFE4B5);padding:50px;border-radius:25px;box-shadow:0 12px 30px rgba(139,69,19,.4);text-align:center;z-index:2000;font-size:32px;font-weight:bold;color:#228B22;border:5px solid #DAA520}
    #danger-alert{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#FFF,#FFE4E1);padding:40px;border-radius:20px;box-shadow:0 12px 30px rgba(220,20,60,.4);text-align:center;z-index:2001;border:4px solid #DC143C;max-width:500px}
    .learn-more-btn{background:linear-gradient(145deg,#DC143C,#8B0000);color:#fff;border:none;padding:15px 30px;font-size:18px;font-weight:bold;border-radius:15px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.3)}
    .danger-legend{display:flex;justify-content:space-around;margin-top:15px;font-size:11px;background:rgba(255,255,255,.9);padding:12px;border-radius:10px;border:2px solid #DC143C;flex-wrap:wrap;gap:8px}
    .danger-box{width:16px;height:16px;border-radius:3px;box-shadow:0 2px 4px rgba(0,0,0,.2)}
    /* ======== Explorer styling (kept + tightened) ======== */
    .container{max-width:1200px;margin:0 auto}
    .subtitle{text-align:center;color:#666;margin-bottom:10px}
    .controls{display:flex;justify-content:center;gap:20px;margin:10px 0 20px;flex-wrap:wrap}
    .filter-btn{padding:10px 18px;border:2px solid var(--leaf);background:#fff;color:var(--leaf);border-radius:25px;cursor:pointer;font-weight:600}
    .filter-btn.active{background:var(--leaf);color:#fff}
    select{padding:10px 20px;border:2px solid var(--leaf);border-radius:25px;font-size:1em;cursor:pointer;background:#fff;color:var(--leaf);font-weight:600}
    .tooltip{position:absolute;background:rgba(0,0,0,.9);color:#fff;padding:12px 16px;border-radius:8px;font-size:14px;pointer-events:none;opacity:0;transition:opacity .3s;z-index:1000;max-width:300px}
    .stats{display:flex;justify-content:space-around;margin-top:20px;gap:20px;flex-wrap:wrap}
    .stat-card{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:18px;border-radius:15px;text-align:center;min-width:150px;flex:1}
    .info-box{background:#f8f9fa;border-left:4px solid var(--leaf);padding:12px;margin-top:16px;border-radius:8px}
    footer{margin:24px 0;text-align:center;color:#6c757d;font-size:12px}
  </style>
</head>
<body>
  <div class="shell">
    <div class="tabs">
      <button class="tab-btn active" data-target="#panel-game">üéÆ Sightings Game</button>
      <button class="tab-btn" data-target="#panel-explorer">üìä Behavior Explorer</button>
    </div>

    <!-- GAME PANEL -->
    <section id="panel-game" class="panel active">
      <div id="game-container" class="card">
        <h1>üçÇCentral Park SightingsüçÇ</h1>
        <div class="progress">üêøÔ∏è Click & Match!üå∞</div>

        <div id="map-container">
          <svg id="map" width="600" height="600" role="img" aria-label="Squirrel game map"></svg>

          <div id="bio-panel" role="dialog" aria-modal="true" aria-labelledby="bio-title">
            <div class="bio-title" id="bio-title"></div>
            <div class="bio-content" id="bio-content"></div>
            <div class="color-buttons">
                <button class="color-btn btn-gray" onclick="checkAnswer('Gray')">Gray</button>
                <button class="color-btn btn-cinnamon" onclick="checkAnswer('Cinnamon')">Cinnamon</button>
                <button class="color-btn btn-black" onclick="checkAnswer('Black')">Black</button>
            </div>
            <div class="feedback" id="feedback"></div>
          </div>
        </div>

        <button class="hint-btn" onclick="toggleHint()">üêøÔ∏èGet a Hint!üêøÔ∏è</button>

        <div class="legend" id="legend" aria-live="polite">
          <div class="legend-item"><div class="legend-circle" style="background:#888"></div><span>Gray (common)</span></div>
          <div class="legend-item"><div class="legend-circle" style="background:#d2691e"></div><span>Cinnamon (moderate)</span></div>
          <div class="legend-item"><div class="legend-circle" style="background:#2c2c2c"></div><span>Black (rare)</span></div>
        </div>
      </div>

      <div id="congratulations">üéâCongratulations! You are a squirrel expert!üéâ</div>
      <div id="danger-alert">
        <h2>‚ö†Ô∏è Alert! Alert! ‚ö†Ô∏è</h2>
        <p>Squirrels don't just moan and twitch for fun! They might be in danger!</p>
        <button class="learn-more-btn" onclick="showDangerMap()">Learn More</button>
      </div>

      <div id="danger-map-container" class="card" style="display:none">
        <h1>üö® Central Park Danger Zones üö®</h1>
        <div class="subtitle">Safety Information</div>
        <div class="danger-legend" aria-hidden="true">
          <div class="danger-legend-item"><div class="danger-box" style="background:#90EE90"></div><span>Safe</span></div>
          <div class="danger-legend-item"><div class="danger-box" style="background:#FFD700"></div><span>Moderate</span></div>
          <div class="danger-legend-item"><div class="danger-box" style="background:#FFA500"></div><span>Dogs Spotted</span></div>
          <div class="danger-legend-item"><div class="danger-box" style="background:#DC143C"></div><span>Danger Zone</span></div>
        </div>
        <div id="danger-map-display"><svg id="danger-svg" width="680" height="520"></svg></div>
      </div>
    </section>

    <!-- EXPLORER PANEL -->
    <section id="panel-explorer" class="panel">
      <div class="card">
        <h1 style="color:var(--leaf);text-align:center;margin-bottom:6px">üêøÔ∏èSquirrel Behavior in Central ParküêøÔ∏è</h1>
        <p class="subtitle">Explore October 2018 observations by fur color, human interactions, and activities.</p>

        <div class="controls">
          <div class="control-group">
            <label><strong>Fur Color Filter:</strong></label>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <button class="filter-btn active" data-color="All">All Colors</button>
              <button class="filter-btn" data-color="Gray">Gray</button>
              <button class="filter-btn" data-color="Cinnamon">Cinnamon</button>
              <button class="filter-btn" data-color="Black">Black</button>
            </div>
          </div>
          <div class="control-group">
            <label><strong>View Type:</strong></label>
            <select id="viewType">
              <option value="behavior">Behavior Patterns</option>
              <option value="interaction">Human Interaction</option>
              <option value="activity">Activity Levels</option>
            </select>
          </div>
        </div>

        <svg id="chart" width="1200" height="500" role="img" aria-label="Behavior chart"></svg>
        <div class="legend" id="legend-explorer"></div>
        <div class="stats" id="stats"></div>
        <div class="info-box"><p><strong>Tutorial:</strong> Use fur color filters and view types to explore patterns. Hover bars for details.</p></div>
      </div>
    </section>

    <footer>Built with D3 v7 ‚Ä¢ Dataset: <code>data/squirrel_output.csv</code></footer>
  </div>

  <div class="loader" id="loader"><div class="spinner"></div>Loading data‚Ä¶</div>

  <script>
    // Simple tab switcher
    document.querySelectorAll('.tab-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
        btn.classList.add('active');
        document.querySelector(btn.dataset.target).classList.add('active');
      });
    });
  </script>

  <!-- ================= GAME SCRIPT (scoped) ================= -->
  <script>
  (function(){
    const squirrels = [
      { id: 1, color: "Black", behaviors: ["runs from", "tail flags"], spottedArea: "above ground", spottingType: "rare", x: 220, y: 80 },
      { id: 2, color: "Gray", behaviors: ["climbing", "moans", "approaches"], spottedArea: "above ground", spottingType: "common", x: 350, y: 130 },
      { id: 3, color: "Gray", behaviors: ["moans", "tail twitches", "foraging"], spottedArea: "on ground", spottingType: "common", x: 340, y: 220 },
      { id: 4, color: "Cinnamon", behaviors: ["chasing", "running"], spottedArea: "on ground", spottingType: "moderate", x: 120, y: 260 },
      { id: 5, color: "Cinnamon", behaviors: ["eating", "chasing"], spottedArea: "on ground", spottingType: "moderate", x: 280, y: 320 },
      { id: 6, color: "Black", behaviors: ["indifferent", "foraging", "kuks"], spottedArea: "on ground", spottingType: "rare", x: 150, y: 380 },
      { id: 7, color: "Gray", behaviors: ["moans", "tail twitches", "runs from"], spottedArea: "on ground", spottingType: "common", x: 90, y: 170 },
      { id: 8, color: "Cinnamon", behaviors: ["chasing", "climbing", "eating"], spottedArea: "above ground", spottingType: "moderate", x: 320, y: 90 },
      { id: 9, color: "Gray", behaviors: ["foraging", "tail flags", "approaches"], spottedArea: "on ground", spottingType: "common", x: 370, y: 180 },
      { id: 10, color: "Black", behaviors: ["indifferent", "tail flags"], spottedArea: "above ground", spottingType: "rare", x: 280, y: 60 },
      { id: 11, color: "Gray", behaviors: ["foraging", "moans", "runs from"], spottedArea: "on ground", spottingType: "common", x: 70, y: 310 },
      { id: 12, color: "Cinnamon", behaviors: ["chasing", "tail twitches", "eating"], spottedArea: "on ground", spottingType: "moderate", x: 350, y: 430 },
      { id: 13, color: "Black", behaviors: ["indifferent", "kuks"], spottedArea: "on ground", spottingType: "rare", x: 140, y: 460 },
      { id: 14, color: "Gray", behaviors: ["foraging", "tail twitches", "climbing"], spottedArea: "above ground", spottingType: "common", x: 250, y: 350 },
      { id: 15, color: "Cinnamon", behaviors: ["running", "chasing", "approaches"], spottedArea: "on ground", spottingType: "moderate", x: 180, y: 420 },
      { id: 16, color: "Gray", behaviors: ["foraging", "approaches", "tail flags"], spottedArea: "on ground", spottingType: "common", x: 360, y: 290 },
      { id: 17, color: "Cinnamon", behaviors: ["eating", "climbing", "chasing"], spottedArea: "above ground", spottingType: "moderate", x: 110, y: 130 },
      { id: 18, color: "Gray", behaviors: ["foraging", "moans", "tail twitches"], spottedArea: "on ground", spottingType: "common", x: 50, y: 150 },
      { id: 19, color: "Gray", behaviors: ["runs from", "tail flags", "foraging"], spottedArea: "on ground", spottingType: "common", x: 150, y: 220 },
      { id: 20, color: "Gray", behaviors: ["approaches", "foraging", "climbing"], spottedArea: "above ground", spottingType: "common", x: 310, y: 400 },
      { id: 21, color: "Gray", behaviors: ["tail twitches", "moans", "foraging"], spottedArea: "on ground", spottingType: "common", x: 90, y: 440 },
      { id: 22, color: "Gray", behaviors: ["foraging", "approaches", "runs from"], spottedArea: "on ground", spottingType: "common", x: 380, y: 120 }
    ];

    let currentSquirrel = null;
    let correctCount = 0;
    const totalSquirrels = squirrels.length;
    const svgGame = d3.select("#map");

    // Draw landmarks first
    const landmarks = svgGame.append("g").attr("class", "landmarks");
    landmarks.append("ellipse").attr("cx", 200).attr("cy", 100).attr("rx", 90).attr("ry", 45).attr("fill", "#4682B4").attr("opacity", 0.7).attr("stroke", "#3A5F8F").attr("stroke-width", 2);
    landmarks.append("text").attr("x",200).attr("y",103).attr("text-anchor","middle").attr("font-size","9px").attr("fill","#FFF").attr("font-weight","bold").text("Reservoir");
    landmarks.append("ellipse").attr("cx", 200).attr("cy", 280).attr("rx", 75).attr("ry", 60).attr("fill", "#4682B4").attr("opacity", 0.7).attr("stroke", "#3A5F8F").attr("stroke-width", 2);
    landmarks.append("text").attr("x",200).attr("y",283).attr("text-anchor","middle").attr("font-size","9px").attr("fill","#FFF").attr("font-weight","bold").text("The Lake");
    const castle = landmarks.append("g");
    castle.append("rect").attr("x", 300).attr("y", 270).attr("width", 28).attr("height", 22).attr("fill", "#8B7355").attr("stroke","#654321").attr("stroke-width",1);
    castle.append("rect").attr("x", 308).attr("y", 256).attr("width", 12).attr("height", 14).attr("fill","#A0826D").attr("stroke","#654321").attr("stroke-width",1);
    castle.append("polygon").attr("points","308,256 320,256 314,247").attr("fill","#8B4513").attr("stroke","#654321").attr("stroke-width",1);
    castle.append("text").attr("x",314).attr("y",305).attr("text-anchor","middle").attr("font-size","7px").attr("fill","#654321").attr("font-weight","bold").text("Castle");

    // Trees
    const treePositions = [{x:130,y:150},{x:270,y:140},{x:350,y:180},{x:85,y:300},{x:320,y:350},{x:180,y:390},{x:260,y:440},{x:150,y:90},{x:340,y:90},{x:60,y:220},{x:380,y:240},{x:240,y:50},{x:170,y:155},{x:300,y:195},{x:220,y:360},{x:95,y:405},{x:365,y:320},{x:130,y:470},{x:280,y:480},{x:45,y:380},{x:385,y:60},{x:325,y:470},{x:205,y:470},{x:155,y:320}];
    const autumnColors = ["#FF6347","#FF8C00","#FFD700","#DC143C","#8B4513"];
    treePositions.forEach((pos,i)=>{
      const c = autumnColors[i % autumnColors.length];
      landmarks.append("rect").attr("x",pos.x-3).attr("y",pos.y).attr("width",6).attr("height",15).attr("fill","#8B4513").attr("rx",1);
      landmarks.append("circle").attr("cx",pos.x).attr("cy",pos.y-3).attr("r",14).attr("fill",c).attr("opacity",0.8);
      landmarks.append("circle").attr("cx",pos.x-5).attr("cy",pos.y-8).attr("r",10).attr("fill",c).attr("opacity",0.7);
      landmarks.append("circle").attr("cx",pos.x+5).attr("cy",pos.y-8).attr("r",10).attr("fill",c).attr("opacity",0.7);
    });

    // Markers
    squirrels.forEach(sq=>{
      const g = svgGame.append("g").attr("class","location-marker").attr("data-id",sq.id).style("cursor","pointer").on("click",()=>showBio(sq));
      g.append("circle").attr("cx",sq.x).attr("cy",sq.y).attr("r",18).attr("fill","#fff").attr("opacity",0.9).attr("stroke","#333").attr("stroke-width",2);
      const icon = g.append("g");
      icon.append("ellipse").attr("cx",sq.x).attr("cy",sq.y+2).attr("rx",6).attr("ry",8).attr("fill","#666").attr("opacity",0.8);
      icon.append("circle").attr("cx",sq.x).attr("cy",sq.y-6).attr("r",5).attr("fill","#666").attr("opacity",0.8);
      icon.append("circle").attr("cx",sq.x-3).attr("cy",sq.y-10).attr("r",2).attr("fill","#666").attr("opacity",0.8);
      icon.append("circle").attr("cx",sq.x+3).attr("cy",sq.y-10).attr("r",2).attr("fill","#666").attr("opacity",0.8);
      icon.append("path").attr("d",`M ${sq.x} ${sq.y+6} Q ${sq.x+8} ${sq.y+2} ${sq.x+8} ${sq.y-8}`).attr("stroke","#666").attr("stroke-width",5).attr("fill","none").attr("stroke-linecap","round").attr("opacity",0.8);
    });

    function toggleHint(){document.getElementById("legend").classList.toggle("visible");}
    window.toggleHint = toggleHint;

    function drawSquirrel(x,y,color,parent){
      const colorMap = {"Gray":"#888","Cinnamon":"#d2691e","Black":"#2c2c2c"};
      const c = colorMap[color];
      parent.append("ellipse").attr("cx",x).attr("cy",y).attr("rx",10).attr("ry",14).attr("fill",c);
      parent.append("ellipse").attr("cx",x).attr("cy",y+2).attr("rx",6).attr("ry",10).attr("fill","#FFF5EE").attr("opacity",0.8);
      parent.append("circle").attr("cx",x).attr("cy",y-12).attr("r",8).attr("fill",c);
      parent.append("circle").attr("cx",x-4).attr("cy",y-17).attr("r",3).attr("fill",c);
      parent.append("circle").attr("cx",x+4).attr("cy",y-17).attr("r",3).attr("fill",c);
      parent.append("path").attr("d",`M ${x} ${y+8} Q ${x+15} ${y} ${x+14} ${y-20}`).attr("stroke",c).attr("stroke-width",8).attr("fill","none").attr("stroke-linecap","round").attr("opacity",0.8);
      parent.append("path").attr("d",`M ${x+2} ${y+6} Q ${x+12} ${y+2} ${x+11} ${y-15}`).attr("stroke",c).attr("stroke-width",4).attr("fill","none").attr("opacity",0.6);
      parent.append("circle").attr("cx",x-2.5).attr("cy",y-13).attr("r",2).attr("fill","#000");
      parent.append("circle").attr("cx",x+2.5).attr("cy",y-13).attr("r",2).attr("fill","#000");
    }

    function showBio(sq){
      if (sq.matched) return;
      window.currentSquirrel = sq;
      document.getElementById("bio-title").textContent = `üçÇ Location ${sq.id} üçÇ`;
      document.getElementById("bio-content").innerHTML = `<strong>üêøÔ∏è Behaviors:</strong> ${sq.behaviors.join(", ")}<br><strong>üìç Spotted:</strong> ${sq.spottedArea}<br><strong>üëÄ Sighting frequency:</strong> ${sq.spottingType}`;
      document.getElementById("bio-panel").style.display="block";
      const fb = document.getElementById("feedback"); fb.textContent=""; fb.className="feedback";
      document.querySelector(".progress").innerHTML = `üå∞ ${correctCount}/${totalSquirrels} squirrels matched correctly üå∞`;
    }

    function rainAcorns(){
      for(let i=0;i<12;i++){
        setTimeout(()=>{
          const el = document.createElement("div");
          el.className="acorn"; el.textContent="üå∞";
          el.style.left = Math.random()*window.innerWidth+"px"; el.style.top="-50px"; document.body.appendChild(el);
          const duration = 1800+Math.random()*900; const rotation = Math.random()*720-360;
          el.animate([{transform:"translateY(0) rotate(0deg)",opacity:1},{transform:`translateY(${window.innerHeight+100}px) rotate(${rotation}deg)`,opacity:0.5}],{duration,easing:"ease-in"});
          setTimeout(()=>el.remove(),duration);
        }, i*50);
      }
    }

    function checkAnswer(sel){
      const sq = window.currentSquirrel;
      if (!sq || sq.matched) return;
      const fb = document.getElementById("feedback");
      if (sel===sq.color){
        fb.textContent="Correct! üéâ"; fb.className="feedback correct";
        sq.matched=true; correctCount++;
        const g = svgGame.select(`g[data-id="${sq.id}"]`); g.selectAll("*").remove(); drawSquirrel(sq.x,sq.y,sq.color,g);
        rainAcorns();
        document.querySelector(".progress").innerHTML = `üå∞ ${correctCount}/${totalSquirrels} squirrels matched correctly üå∞`;
        setTimeout(()=>{
          if (correctCount===totalSquirrels){ showCongratulations(); }
          else { document.getElementById("bio-panel").style.display="none"; window.currentSquirrel=null; }
        }, 1200);
      } else {
        fb.textContent="Try again! üçÅ"; fb.className="feedback incorrect";
      }
    }
    window.checkAnswer = checkAnswer;

    function rainSquirrelsAndAcorns(){
      const items = ['üêøÔ∏è','üå∞','üçÇ','üçÅ'];
      for (let i=0;i<30;i++){
        setTimeout(()=>{
          const el = document.createElement("div"); el.className="falling-squirrel";
          el.textContent = items[Math.floor(Math.random()*items.length)];
          el.style.left = Math.random()*window.innerWidth+"px"; el.style.top="-50px"; el.style.fontSize = (20+Math.random()*20)+"px";
          document.body.appendChild(el);
          const duration = 2800+Math.random()*1800; const rotation = Math.random()*1080-540;
          el.animate([{transform:"translateY(0) rotate(0deg)",opacity:1},{transform:`translateY(${window.innerHeight+100}px) rotate(${rotation}deg)`,opacity:0.3}],{duration,easing:"ease-in"});
          setTimeout(()=>el.remove(),duration);
        }, i*30);
      }
    }

    function showCongratulations(){
      document.getElementById("bio-panel").style.display="none";
      document.getElementById("congratulations").style.display="block";
      for (let i=0;i<3;i++) setTimeout(()=>rainSquirrelsAndAcorns(), i*700);
      setTimeout(()=>{ document.getElementById("congratulations").style.display="none"; document.getElementById("danger-alert").style.display="block"; }, 4200);
    }

    function showDangerMap(){
      document.getElementById("danger-alert").style.display="none";
      document.getElementById("game-container").style.display="none";
      document.getElementById("danger-map-container").style.display="block";
      const dangerSvg = d3.select("#danger-svg");
      dangerSvg.append("rect").attr("x",0).attr("y",0).attr("width",680).attr("height",520).attr("fill","#2E8B57");
      // Yellow and other zones (condensed for brevity)
      dangerSvg.append("ellipse").attr("cx",340).attr("cy",350).attr("rx",140).attr("ry",160).attr("fill","#FFD700").attr("opacity",0.35);
      dangerSvg.append("circle").attr("cx",340).attr("cy",350).attr("r",70).attr("fill","#FFA500").attr("opacity",0.6);
      const redZone={cx:120,cy:120,r:40};
      dangerSvg.append("circle").attr("cx",redZone.cx).attr("cy",redZone.cy).attr("r",redZone.r).attr("fill","#FF4C4C").attr("opacity",0.85);
      // Some landmarks for orientation
      dangerSvg.append("ellipse").attr("cx",220).attr("cy",100).attr("rx",95).attr("ry",45).attr("fill","#4682B4").attr("opacity",0.6).attr("stroke","#3A5F8F").attr("stroke-width",2);
      dangerSvg.append("text").attr("x",220).attr("y",103).attr("text-anchor","middle").attr("font-size","10px").attr("fill","#fff").text("Reservoir");
      // Sample squirrels
      drawSquirrelOnMap(80,100,"Black",dangerSvg);
      drawSquirrelOnMap(120,120,"Gray",dangerSvg);
      drawSquirrelOnMap(340,350,"Cinnamon",dangerSvg);
      drawSquirrelOnMap(200,400,"Gray",dangerSvg);
    }
    window.showDangerMap = showDangerMap;

    function drawSquirrelOnMap(x,y,color,svgSel){
      const colorMap={"Gray":"#888","Cinnamon":"#d2691e","Black":"#2c2c2c"};
      const c=colorMap[color]; const g = svgSel.append("g");
      g.append("ellipse").attr("cx",x).attr("cy",y).attr("rx",8).attr("ry",11).attr("fill",c);
      g.append("ellipse").attr("cx",x).attr("cy",y+2).attr("rx",5).attr("ry",8).attr("fill","#FFF5EE").attr("opacity",0.8);
      g.append("circle").attr("cx",x).attr("cy",y-10).attr("r",6).attr("fill",c);
      g.append("path").attr("d",`M ${x} ${y+6} Q ${x+12} ${y} ${x+11} ${y-16}`).attr("stroke",c).attr("stroke-width",6).attr("fill","none").attr("stroke-linecap","round").attr("opacity",0.8);
    }
  })();
  </script>

  <!-- ================= EXPLORER SCRIPT (scoped) ================= -->
  <script>
  (function(){
    const margin = {top: 40, right: 30, bottom: 80, left: 60};
    const width = 1200 - margin.left - margin.right;
    const height = 500 - margin.top - margin.bottom;

    const svg = d3.select('#chart').append('g').attr('transform', `translate(${margin.left},${margin.top})`);

    const tooltip = d3.select('body').append('div').attr('class','tooltip').style('opacity',0);
    const legendNode = d3.select('#legend-explorer');
    const statsNode = d3.select('#stats');
    const loader = document.getElementById('loader');

    let rawData = [];
    let currentFilter = 'All';
    let currentView = 'behavior';

    function isTrue(v){
      if (!v) return false;
      const s = String(v).trim().toUpperCase();
      return s==='TRUE'||s==='1'||s==='YES';
    }

    // Load local CSV (placed in /data)
    function loadData(){
      loader.classList.add('show');
      d3.csv('data/squirrel_output.csv').then(data=>{
        rawData = data.map(row=>{
          const out={};
          Object.keys(row).forEach(k=>{ out[k.trim()] = row[k] ? row[k].trim() : ''; });
        return out; });
        updateVisualization();
        loader.classList.remove('show');
      }).catch(err=>{
        loader.classList.remove('show');
        alert('Failed to load data/squirrel_output.csv. Please ensure the file exists in /data on your GitHub repo.');
        console.error(err);
      });
    }
    loadData();

    // Event listeners
    document.querySelectorAll('#panel-explorer .filter-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('#panel-explorer .filter-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.color;
        updateVisualization();
      });
    });
    document.getElementById('viewType').addEventListener('change', (e)=>{
      currentView = e.target.value;
      updateVisualization();
    });

    function updateVisualization(){
      if (!rawData.length) return;
      let filtered = rawData;
      if (currentFilter!=='All'){
        filtered = rawData.filter(d=> d['Primary Fur Color']===currentFilter);
      }

      let chartData, xLabel, yLabel, title;
      if (currentView==='behavior'){
        chartData = countColumns(filtered, ['Running','Climbing','Eating','Foraging','Chasing'], 'Behavior Patterns');
        xLabel='Behavior Type'; yLabel='Number of Observations'; title='Squirrel Behavior Patterns';
      } else if (currentView==='interaction'){
        chartData = countColumns(filtered, ['Approaches','Indifferent','Runs from'], 'Human-Squirrel Interactions', {'Runs from':'Runs From'});
        xLabel='Interaction Type'; yLabel='Number of Squirrels'; title='Human-Squirrel Interactions';
      } else {
        chartData = countColumns(filtered, ['Kuks','Quaas','Moans','Tail flags','Tail twitches'], 'Activity Levels', {'Tail flags':'Tail Flags','Tail twitches':'Tail Twitches'});
        xLabel='Activity Type'; yLabel='Number of Observations'; title='Squirrel Activity Levels';
      }
      drawChart(chartData, xLabel, yLabel, title);
      updateStats(filtered, chartData);
    }

    function countColumns(data, keys, _title, labelMap={}){
      return keys.map(k=>{
        const count = data.filter(d=> isTrue(d[k])).length;
        const label = labelMap[k] || k;
        return {category:label, value:count, percentage: data.length? (count/data.length*100).toFixed(1): 0};
      });
    }

    function drawChart(data, xLabel, yLabel, title){
      svg.selectAll('*').remove();
      const x = d3.scaleBand().domain(data.map(d=>d.category)).range([0,width]).padding(0.2);
      const maxValue = d3.max(data, d=>d.value) || 10;
      const y = d3.scaleLinear().domain([0,maxValue]).nice().range([height,0]);
      const color = d3.scaleOrdinal().domain(data.map(d=>d.category)).range(['#2c5f2d','#97bc62','#d4a373','#8b7355','#5d8233']);

      svg.selectAll('.bar')
        .data(data)
        .join(enter=> enter.append('rect')
          .attr('class','bar')
          .attr('x', d=>x(d.category))
          .attr('width', x.bandwidth())
          .attr('y', height).attr('height',0).attr('fill', d=>color(d.category)).attr('rx',8)
          .call(enter=> enter.transition().duration(800).attr('y', d=>y(d.value)).attr('height', d=> height - y(d.value)))
        ,update=> update.call(update=> update.transition().duration(800)
          .attr('x', d=>x(d.category))
          .attr('width', x.bandwidth())
          .attr('y', d=>y(d.value))
          .attr('height', d=> height - y(d.value))
          .attr('fill', d=>color(d.category))
        ))
        .on('mousemove', function(event, d){
          tooltip.style('opacity',1)
            .html(`<strong>${d.category}</strong><br/>Count: ${d.value.toLocaleString()}<br/>Percentage: ${d.percentage}%`)
            .style('left', (event.pageX+10)+'px')
            .style('top', (event.pageY-10)+'px');
        })
        .on('mouseout', ()=> tooltip.style('opacity',0));

      // Axes
      svg.append('g').attr('transform',`translate(0,${height})`).call(d3.axisBottom(x)).selectAll('text').attr('transform','rotate(-45)').style('text-anchor','end').attr('dx','-.8em').attr('dy','.15em');
      svg.append('g').call(d3.axisLeft(y));

      // Labels
      svg.append('text').attr('text-anchor','middle').attr('x', width/2).attr('y', height+60).style('font-weight','600').text(xLabel);
      svg.append('text').attr('text-anchor','middle').attr('transform','rotate(-90)').attr('x', -height/2).attr('y', -40).style('font-weight','600').text(yLabel);
      svg.append('text').attr('x', width/2).attr('y', -10).attr('text-anchor','middle').style('font-size','18px').style('font-weight','700').style('fill','#2c5f2d').text(title);

      // Legend
      legendNode.selectAll('*').remove();
      const items = legendNode.selectAll('.legend-item').data(data).join('div').attr('class','legend-item');
      items.append('div').attr('class','legend-color').style('width','18px').style('height','18px').style('border-radius','4px').style('background', d=>color(d.category));
      items.append('span').text(d=> `${d.category}: ${d.value}`);
    }

    function updateStats(data, chartData){
      statsNode.selectAll('*').remove();
      const total = data.length;
      const common = chartData.reduce((a,b)=> a.value>b.value?a:b, {value: -1}).category;
      const avg = chartData.length? d3.mean(chartData, d=>d.value).toFixed(0): 0;
      const ds = [
        {label:'Total Squirrels', value: total},
        {label:'Most Common', value: common},
        {label:'Avg Count', value: avg}
      ];
      statsNode.selectAll('.stat-card').data(ds).join('div').attr('class','stat-card').html(d=> `<h3>${d.value}</h3><p>${d.label}</p>`);
    }
  })();
  </script>
</body>
</html>
